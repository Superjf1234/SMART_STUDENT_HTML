<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Real - Notificaci√≥n Tarea Completa</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .info {
            color: blue;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Real: Verificar Notificaci√≥n Tarea Completa</h1>
        
        <div class="section">
            <h2>üîß Diagn√≥stico del Sistema Real</h2>
            <button class="button" onclick="checkCurrentData()">1. Verificar Datos Actuales</button>
            <button class="button" onclick="simulateRealScenario()">2. Simular Escenario Real</button>
            <button class="button" onclick="checkNotificationFlow()">3. Verificar Flujo de Notificaciones</button>
            <button class="button" onclick="debugSubmissionProcess()">4. Debug Proceso de Entrega</button>
        </div>

        <div class="section">
            <h2>üìã Resultados del Diagn√≥stico</h2>
            <div id="results" class="log-output"></div>
        </div>

        <div class="section">
            <h2>üîç Estado del Sistema</h2>
            <div id="status" class="log-output"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : 
                            type === 'error' ? 'error' : 
                            type === 'warning' ? 'warning' : 'info';
            
            resultsDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function updateStatus() {
            const statusDiv = document.getElementById('status');
            const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '{}');
            
            statusDiv.innerHTML = `
üìä Estado del Sistema:
‚Ä¢ Tareas: ${tasks.length}
‚Ä¢ Comentarios: ${comments.length}
‚Ä¢ Notificaciones: ${notifications.length}
‚Ä¢ Usuarios: ${Object.keys(users).length}

üîç Notificaciones por tipo:
${Object.entries(
    notifications.reduce((acc, n) => {
        acc[n.type] = (acc[n.type] || 0) + 1;
        return acc;
    }, {})
).map(([type, count]) => `‚Ä¢ ${type}: ${count}`).join('\n') || 'Ninguna'}

üìã Tareas con entregas:
${tasks.map(task => {
    const submissions = comments.filter(c => c.taskId === task.id && c.isSubmission);
    return `‚Ä¢ ${task.title}: ${submissions.length} entrega(s)`;
}).join('\n') || 'Ninguna'}
            `.trim();
        }

        function checkCurrentData() {
            log('üîç Verificando datos actuales del sistema...', 'info');
            
            const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '{}');
            
            log(`üìä Datos encontrados:`, 'info');
            log(`‚Ä¢ Tareas: ${tasks.length}`, 'info');
            log(`‚Ä¢ Comentarios/Entregas: ${comments.length}`, 'info');
            log(`‚Ä¢ Notificaciones: ${notifications.length}`, 'info');
            log(`‚Ä¢ Usuarios: ${Object.keys(users).length}`, 'info');
            
            // Verificar entregas por tarea
            tasks.forEach(task => {
                const submissions = comments.filter(c => c.taskId === task.id && c.isSubmission);
                log(`üìù Tarea "${task.title}": ${submissions.length} entrega(s)`, 'info');
                
                if (submissions.length > 0) {
                    submissions.forEach(sub => {
                        log(`  - ${sub.studentName} (${sub.studentId}) - ${new Date(sub.timestamp).toLocaleString()}`, 'info');
                    });
                }
            });
            
            // Verificar notificaciones de tarea completa
            const taskCompletedNotifications = notifications.filter(n => n.type === 'task_completed');
            log(`üéØ Notificaciones de tarea completa: ${taskCompletedNotifications.length}`, taskCompletedNotifications.length > 0 ? 'success' : 'warning');
            
            taskCompletedNotifications.forEach(notif => {
                log(`  - ${notif.taskTitle} para ${notif.targetUsernames.join(', ')}`, 'info');
            });
            
            updateStatus();
        }

        function simulateRealScenario() {
            log('üé≠ Simulando escenario real con datos existentes...', 'info');
            
            const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '{}');
            
            if (tasks.length === 0) {
                log('‚ùå No hay tareas en el sistema', 'error');
                return;
            }
            
            // Buscar una tarea del profesor jorge
            const jorgeTask = tasks.find(t => t.assignedById === 'jorge');
            if (!jorgeTask) {
                log('‚ùå No se encontr√≥ ninguna tarea asignada por jorge', 'error');
                return;
            }
            
            log(`‚úÖ Tarea encontrada: "${jorgeTask.title}"`, 'success');
            log(`üìã Detalles:`, 'info');
            log(`  - ID: ${jorgeTask.id}`, 'info');
            log(`  - Curso: ${jorgeTask.course}`, 'info');
            log(`  - Asignada por: ${jorgeTask.assignedById}`, 'info');
            log(`  - Tipo: ${jorgeTask.taskType}`, 'info');
            
            // Verificar estudiantes en el curso
            const studentsInCourse = Object.values(users).filter(u => 
                u.role === 'student' && 
                u.activeCourses && 
                u.activeCourses.includes(jorgeTask.course)
            );
            
            log(`üë• Estudiantes en el curso: ${studentsInCourse.length}`, 'info');
            studentsInCourse.forEach(student => {
                log(`  - ${student.displayName} (${student.id})`, 'info');
            });
            
            // Verificar entregas para esta tarea
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            const submissions = comments.filter(c => c.taskId === jorgeTask.id && c.isSubmission);
            
            log(`üìù Entregas para esta tarea: ${submissions.length}`, 'info');
            submissions.forEach(sub => {
                log(`  - ${sub.studentName} (${sub.studentId}) - ${new Date(sub.timestamp).toLocaleString()}`, 'info');
            });
            
            // Verificar si todos han entregado
            const allSubmitted = studentsInCourse.every(student => 
                submissions.some(sub => sub.studentId === student.id)
            );
            
            log(`üéØ ¬øTodos los estudiantes han entregado? ${allSubmitted ? 'S√ç' : 'NO'}`, allSubmitted ? 'success' : 'warning');
            
            // Si no todos han entregado, simular entrega faltante
            if (!allSubmitted) {
                const missingStudents = studentsInCourse.filter(student => 
                    !submissions.some(sub => sub.studentId === student.id)
                );
                
                log(`‚ùå Estudiantes que faltan por entregar: ${missingStudents.length}`, 'warning');
                missingStudents.forEach(student => {
                    log(`  - ${student.displayName} (${student.id})`, 'warning');
                });
                
                // Simular entrega del primer estudiante faltante
                if (missingStudents.length > 0) {
                    const student = missingStudents[0];
                    log(`üöÄ Simulando entrega de ${student.displayName}...`, 'info');
                    
                    const newSubmission = {
                        id: 'sim_' + Date.now(),
                        taskId: jorgeTask.id,
                        studentId: student.id,
                        studentName: student.displayName,
                        comment: 'Entrega simulada para test',
                        timestamp: new Date().toISOString(),
                        isSubmission: true,
                        attachments: []
                    };
                    
                    comments.push(newSubmission);
                    localStorage.setItem('smart-student-task-comments', JSON.stringify(comments));
                    
                    log(`‚úÖ Entrega simulada creada`, 'success');
                    
                    // Verificar nuevamente si todos han entregado
                    const newSubmissions = comments.filter(c => c.taskId === jorgeTask.id && c.isSubmission);
                    const nowAllSubmitted = studentsInCourse.every(student => 
                        newSubmissions.some(sub => sub.studentId === student.id)
                    );
                    
                    log(`üéØ ¬øAhora todos han entregado? ${nowAllSubmitted ? 'S√ç' : 'NO'}`, nowAllSubmitted ? 'success' : 'warning');
                    
                    if (nowAllSubmitted) {
                        log(`üöÄ Deber√≠a crearse notificaci√≥n de tarea completa...`, 'info');
                        
                        // Simular creaci√≥n de notificaci√≥n
                        const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
                        
                        const newNotification = {
                            id: `completed_${jorgeTask.id}_${Date.now()}`,
                            type: 'task_completed',
                            taskId: jorgeTask.id,
                            taskTitle: jorgeTask.title,
                            targetUserRole: 'teacher',
                            targetUsernames: [jorgeTask.assignedById],
                            fromUsername: 'system',
                            fromDisplayName: 'Estudiante',
                            course: jorgeTask.course,
                            subject: jorgeTask.subject,
                            timestamp: new Date().toISOString(),
                            read: false,
                            readBy: [],
                            taskType: jorgeTask.taskType === 'evaluacion' ? 'evaluation' : 'assignment'
                        };
                        
                        notifications.push(newNotification);
                        localStorage.setItem('smart-student-task-notifications', JSON.stringify(notifications));
                        
                        log(`‚úÖ Notificaci√≥n de tarea completa creada manualmente`, 'success');
                        log(`üì¢ ID: ${newNotification.id}`, 'info');
                        log(`üì¢ Para: ${newNotification.targetUsernames.join(', ')}`, 'info');
                        log(`üì¢ Tipo: ${newNotification.taskType}`, 'info');
                    }
                }
            }
            
            updateStatus();
        }

        function checkNotificationFlow() {
            log('üîÑ Verificando flujo de notificaciones...', 'info');
            
            const notifications = JSON.parse(localStorage.getItem('smart-student-task-notifications') || '[]');
            const taskCompletedNotifications = notifications.filter(n => n.type === 'task_completed');
            
            log(`üì¢ Notificaciones de tarea completa: ${taskCompletedNotifications.length}`, 'info');
            
            if (taskCompletedNotifications.length > 0) {
                taskCompletedNotifications.forEach((notif, index) => {
                    log(`${index + 1}. ${notif.taskTitle}`, 'success');
                    log(`   - Para: ${notif.targetUsernames.join(', ')}`, 'info');
                    log(`   - Tipo: ${notif.taskType}`, 'info');
                    log(`   - Le√≠da: ${notif.read ? 'S√ç' : 'NO'}`, 'info');
                    log(`   - Timestamp: ${new Date(notif.timestamp).toLocaleString()}`, 'info');
                });
                
                log(`‚úÖ Las notificaciones existen. Revisar panel de notificaciones del profesor.`, 'success');
            } else {
                log(`‚ùå No hay notificaciones de tarea completa`, 'error');
                log(`üîß Esto indica que el flujo de creaci√≥n no se est√° ejecutando`, 'warning');
            }
            
            updateStatus();
        }

        function debugSubmissionProcess() {
            log('üêõ Debugging proceso de entrega...', 'info');
            
            // Simular el proceso paso a paso
            const tasks = JSON.parse(localStorage.getItem('smart-student-tasks') || '[]');
            const comments = JSON.parse(localStorage.getItem('smart-student-task-comments') || '[]');
            const users = JSON.parse(localStorage.getItem('smart-student-users') || '{}');
            
            if (tasks.length === 0) {
                log('‚ùå No hay tareas para debuggear', 'error');
                return;
            }
            
            const task = tasks[0];
            log(`üîç Debuggeando tarea: "${task.title}"`, 'info');
            
            // Paso 1: Obtener estudiantes asignados
            const studentsInCourse = Object.values(users).filter(u => 
                u.role === 'student' && 
                u.activeCourses && 
                u.activeCourses.includes(task.course)
            );
            
            log(`üë• Estudiantes en curso: ${studentsInCourse.length}`, 'info');
            
            // Paso 2: Verificar entregas
            const submissions = comments.filter(c => c.taskId === task.id && c.isSubmission);
            log(`üìù Entregas: ${submissions.length}`, 'info');
            
            // Paso 3: Verificar cada estudiante
            studentsInCourse.forEach(student => {
                const hasSubmitted = submissions.some(sub => sub.studentId === student.id);
                log(`‚úÖ ${student.displayName} (${student.id}): ${hasSubmitted ? 'ENTREGADO' : 'PENDIENTE'}`, hasSubmitted ? 'success' : 'warning');
            });
            
            // Paso 4: Verificar condici√≥n de todos entregaron
            const allSubmitted = studentsInCourse.every(student => 
                submissions.some(sub => sub.studentId === student.id)
            );
            
            log(`üéØ Condici√≥n "todos entregaron": ${allSubmitted}`, allSubmitted ? 'success' : 'warning');
            
            // Paso 5: Mostrar lo que pasar√≠a
            if (allSubmitted) {
                log(`üöÄ Deber√≠a ejecutarse createTaskCompletedNotification()`, 'success');
                log(`   - taskId: ${task.id}`, 'info');
                log(`   - taskTitle: ${task.title}`, 'info');
                log(`   - teacherUsername: ${task.assignedById}`, 'info');
                log(`   - taskType: ${task.taskType === 'evaluacion' ? 'evaluation' : 'assignment'}`, 'info');
            } else {
                log(`‚è≥ Faltan estudiantes por entregar`, 'warning');
            }
            
            updateStatus();
        }

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
        });
    </script>
</body>
</html>
