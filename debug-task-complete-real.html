<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Notificaciones de Tarea Completa Real</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .log {
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug - Notificaciones de Tarea Completa (Datos Reales)</h1>
        
        <div class="section">
            <h2>üìã Datos Actuales del Sistema</h2>
            <button onclick="showCurrentData()">üîç Mostrar Datos Actuales</button>
            <button onclick="showNotifications()">üì¢ Mostrar Notificaciones</button>
            <button onclick="showComments()">üí¨ Mostrar Comentarios</button>
        </div>
        
        <div class="section">
            <h2>üéØ Simulaci√≥n de Flujo Completo</h2>
            <button onclick="simulateTaskFlow()">üöÄ Simular Flujo de Tarea</button>
            <button onclick="testTaskCompletedNotification()">‚úÖ Test Notificaci√≥n Completa</button>
        </div>
        
        <div class="section">
            <h2>üìä Resultados</h2>
            <div id="results"></div>
        </div>
        
        <div class="section">
            <h2>üêõ Logs de Debug</h2>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function showResults(title, data) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.innerHTML = `<h3>${title}</h3><div class="data-display">${JSON.stringify(data, null, 2)}</div>`;
            resultsDiv.appendChild(resultDiv);
        }
        
        function showCurrentData() {
            log('üìã Mostrando datos actuales del sistema...', 'info');
            
            // Mostrar usuarios
            const usersText = localStorage.getItem('smart-student-users');
            const users = usersText ? JSON.parse(usersText) : [];
            showResults('üë• Usuarios del Sistema', users);
            
            // Mostrar tareas
            const tasksText = localStorage.getItem('smart-student-tasks');
            const tasks = tasksText ? JSON.parse(tasksText) : [];
            showResults('üìö Tareas del Sistema', tasks);
            
            // Mostrar cursos
            const coursesText = localStorage.getItem('smart-student-courses');
            const courses = coursesText ? JSON.parse(coursesText) : [];
            showResults('üè´ Cursos del Sistema', courses);
            
            // Usuario actual
            const currentUser = localStorage.getItem('smart_student_current_user');
            showResults('üë§ Usuario Actual', currentUser);
            
            log('‚úÖ Datos mostrados', 'success');
        }
        
        function showNotifications() {
            log('üì¢ Mostrando notificaciones actuales...', 'info');
            
            const notificationsText = localStorage.getItem('smart_student_notifications');
            const notifications = notificationsText ? JSON.parse(notificationsText) : [];
            
            showResults('üîî Notificaciones', notifications);
            
            // Filtrar notificaciones de tarea completa
            const completedNotifications = notifications.filter(n => n.type === 'task_completed');
            showResults('‚úÖ Notificaciones de Tarea Completa', completedNotifications);
            
            log(`üìä Total notificaciones: ${notifications.length}, Tareas completas: ${completedNotifications.length}`, 'info');
        }
        
        function showComments() {
            log('üí¨ Mostrando comentarios actuales...', 'info');
            
            const commentsText = localStorage.getItem('smart-student-comments');
            const comments = commentsText ? JSON.parse(commentsText) : [];
            
            showResults('üí¨ Comentarios', comments);
            
            // Filtrar entregas
            const submissions = comments.filter(c => c.isSubmission);
            showResults('üìù Entregas de Estudiantes', submissions);
            
            log(`üìä Total comentarios: ${comments.length}, Entregas: ${submissions.length}`, 'info');
        }
        
        function simulateTaskFlow() {
            log('üöÄ Iniciando simulaci√≥n de flujo de tarea...', 'info');
            
            // Obtener datos reales
            const tasksText = localStorage.getItem('smart-student-tasks');
            const tasks = tasksText ? JSON.parse(tasksText) : [];
            
            const usersText = localStorage.getItem('smart-student-users');
            const users = usersText ? JSON.parse(usersText) : [];
            
            const commentsText = localStorage.getItem('smart-student-comments');
            const comments = commentsText ? JSON.parse(commentsText) : [];
            
            if (tasks.length === 0) {
                log('‚ö†Ô∏è No hay tareas en el sistema', 'warning');
                return;
            }
            
            // Tomar la primera tarea
            const task = tasks[0];
            log(`üìö Analizando tarea: "${task.title}" (ID: ${task.id})`, 'info');
            
            // Obtener estudiantes del curso
            const studentsInCourse = users.filter(u => 
                u.role === 'student' && 
                u.activeCourses?.includes(task.course)
            );
            
            log(`üë• Estudiantes en el curso: ${studentsInCourse.length}`, 'info');
            studentsInCourse.forEach(student => {
                log(`  - ${student.displayName} (${student.username}) - ID: ${student.id}`, 'info');
            });
            
            // Verificar entregas
            const taskSubmissions = comments.filter(c => 
                c.taskId === task.id && c.isSubmission
            );
            
            log(`üìù Entregas encontradas: ${taskSubmissions.length}`, 'info');
            taskSubmissions.forEach(submission => {
                log(`  - ${submission.studentName} (${submission.studentId}) - ${submission.timestamp}`, 'info');
            });
            
            // Verificar si todos han entregado
            const allSubmitted = studentsInCourse.every(student => {
                const hasSubmission = taskSubmissions.some(submission => 
                    submission.studentId === student.id || 
                    submission.studentName === student.displayName ||
                    submission.studentName === student.username
                );
                log(`  ‚úÖ ${student.displayName}: ${hasSubmission ? 'ENTREGADO' : 'PENDIENTE'}`, hasSubmission ? 'success' : 'warning');
                return hasSubmission;
            });
            
            log(`üéØ Todos los estudiantes han entregado: ${allSubmitted ? 'S√ç' : 'NO'}`, allSubmitted ? 'success' : 'warning');
            
            if (allSubmitted) {
                log('üöÄ Deber√≠a crearse notificaci√≥n de tarea completa', 'success');
                testTaskCompletedNotification();
            }
        }
        
        function testTaskCompletedNotification() {
            log('‚úÖ Testing notificaci√≥n de tarea completa...', 'info');
            
            // Simular TaskNotificationManager.createTaskCompletedNotification
            const tasksText = localStorage.getItem('smart-student-tasks');
            const tasks = tasksText ? JSON.parse(tasksText) : [];
            
            if (tasks.length === 0) {
                log('‚ö†Ô∏è No hay tareas para testear', 'warning');
                return;
            }
            
            const task = tasks[0];
            
            // Simular la funci√≥n
            const notificationsText = localStorage.getItem('smart_student_notifications');
            const notifications = notificationsText ? JSON.parse(notificationsText) : [];
            
            log(`üìã Notificaciones actuales: ${notifications.length}`, 'info');
            
            // Verificar si ya existe
            const existingNotification = notifications.find(n => 
                n.type === 'task_completed' && 
                n.taskId === task.id &&
                n.targetUsernames.includes(task.assignedById)
            );
            
            if (existingNotification) {
                log(`‚ö†Ô∏è Ya existe notificaci√≥n de tarea completa para taskId: ${task.id}`, 'warning');
                return;
            }
            
            // Crear nueva notificaci√≥n
            const newNotification = {
                id: `completed_${task.id}_${Date.now()}`,
                type: 'task_completed',
                taskId: task.id,
                taskTitle: task.title,
                targetUserRole: 'teacher',
                targetUsernames: [task.assignedById],
                fromUsername: 'system',
                fromDisplayName: 'Estudiante',
                course: task.course,
                subject: task.subject,
                timestamp: new Date().toISOString(),
                read: false,
                readBy: [],
                taskType: task.taskType === 'evaluacion' ? 'evaluation' : 'assignment'
            };
            
            notifications.push(newNotification);
            localStorage.setItem('smart_student_notifications', JSON.stringify(notifications));
            
            log('üì¢ Notificaci√≥n de tarea completa creada', 'success');
            log(`üéØ Notificaci√≥n: ${JSON.stringify(newNotification, null, 2)}`, 'success');
            
            // Mostrar notificaciones actualizadas
            showNotifications();
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Sistema de debug inicializado', 'success');
        });
    </script>
</body>
</html>
