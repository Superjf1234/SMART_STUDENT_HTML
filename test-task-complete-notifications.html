<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Notificaciones de Tarea Completa</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .log {
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        
        .notification-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
        }
        .notification-completed {
            border-left: 4px solid #28a745;
        }
        .notification-pending {
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Test de Notificaciones de Tarea Completa</h1>
        
        <div class="section">
            <h2>üìã Configuraci√≥n de Prueba</h2>
            <button onclick="setupTestData()">üìä Configurar Datos de Prueba</button>
            <button onclick="clearNotifications()">üßπ Limpiar Notificaciones</button>
            <button onclick="showCurrentNotifications()">üëÅÔ∏è Ver Notificaciones Actuales</button>
        </div>
        
        <div class="section">
            <h2>üéØ Simulaci√≥n de Entregas</h2>
            <button onclick="simulateStudentSubmission('alice')">üë© Alice entrega</button>
            <button onclick="simulateStudentSubmission('bob')">üë® Bob entrega</button>
            <button onclick="simulateStudentSubmission('charlie')">üë§ Charlie entrega</button>
            <button onclick="simulateAllStudentsSubmit()">üìö Todos entregan</button>
        </div>
        
        <div class="section">
            <h2>üì¢ Panel de Notificaciones del Profesor</h2>
            <div id="notificationsPanel">
                <div id="tasksPending"></div>
                <div id="tasksCompleted"></div>
            </div>
        </div>
        
        <div class="section">
            <h2>üêõ Logs de Debugging</h2>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        let currentUser = 'jorge'; // Profesor
        let testTask = {
            id: 'test_task_123',
            title: 'An√°lisis de Casos de Uso',
            course: 'course_1',
            subject: 'Sistemas',
            assignedById: 'jorge',
            taskType: 'assignment'
        };
        
        let testStudents = [
            { username: 'alice', displayName: 'Alice Garc√≠a', course: 'course_1' },
            { username: 'bob', displayName: 'Bob Mart√≠nez', course: 'course_1' },
            { username: 'charlie', displayName: 'Charlie L√≥pez', course: 'course_1' }
        ];
        
        let submissions = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        // Simulaci√≥n de TaskNotificationManager
        class TaskNotificationManager {
            static getNotifications() {
                const notifications = localStorage.getItem('smart_student_notifications');
                return notifications ? JSON.parse(notifications) : [];
            }
            
            static saveNotifications(notifications) {
                localStorage.setItem('smart_student_notifications', JSON.stringify(notifications));
            }
            
            static createTaskCompletedNotification(taskId, taskTitle, course, subject, teacherUsername, taskType = 'assignment') {
                log(`üöÄ createTaskCompletedNotification: Iniciando para taskId=${taskId}, teacher=${teacherUsername}`, 'info');
                
                const notifications = this.getNotifications();
                log(`üìã Notificaciones actuales: ${notifications.length}`, 'info');
                
                // Verificar si ya existe una notificaci√≥n de tarea completa para esta tarea
                const existingNotification = notifications.find(n => 
                    n.type === 'task_completed' && 
                    n.taskId === taskId &&
                    n.targetUsernames.includes(teacherUsername)
                );
                
                if (existingNotification) {
                    log(`‚ö†Ô∏è Ya existe notificaci√≥n de tarea completa para taskId: ${taskId}`, 'warning');
                    return;
                }
                
                const newNotification = {
                    id: `completed_${taskId}_${Date.now()}`,
                    type: 'task_completed',
                    taskId,
                    taskTitle,
                    targetUserRole: 'teacher',
                    targetUsernames: [teacherUsername],
                    fromUsername: 'system',
                    fromDisplayName: 'Estudiante',
                    course,
                    subject,
                    timestamp: new Date().toISOString(),
                    read: false,
                    readBy: [],
                    taskType
                };
                
                notifications.push(newNotification);
                this.saveNotifications(notifications);
                
                log(`üì¢ Notificaci√≥n de tarea completa creada para profesor: ${teacherUsername}`, 'success');
                log(`üéØ Notificaci√≥n creada: ${JSON.stringify(newNotification, null, 2)}`, 'success');
                
                updateNotificationsPanel();
            }
            
            static createTaskSubmissionNotification(taskId, taskTitle, course, subject, studentUsername, teacherUsername, taskType = 'assignment') {
                log(`üìù Creando notificaci√≥n de entrega para ${studentUsername} -> ${teacherUsername}`, 'info');
                
                const notifications = this.getNotifications();
                
                const newNotification = {
                    id: `submission_${taskId}_${studentUsername}_${Date.now()}`,
                    type: 'task_submission',
                    taskId,
                    taskTitle,
                    targetUserRole: 'teacher',
                    targetUsernames: [teacherUsername],
                    fromUsername: studentUsername,
                    fromDisplayName: testStudents.find(s => s.username === studentUsername)?.displayName || studentUsername,
                    course,
                    subject,
                    timestamp: new Date().toISOString(),
                    read: false,
                    readBy: [],
                    taskType
                };
                
                notifications.push(newNotification);
                this.saveNotifications(notifications);
                
                log(`üì§ Notificaci√≥n de entrega creada`, 'success');
                updateNotificationsPanel();
            }
        }
        
        function setupTestData() {
            log('üîß Configurando datos de prueba...', 'info');
            
            // Limpiar datos previos
            submissions = [];
            
            // Configurar localStorage con datos de prueba
            localStorage.setItem('smart_student_current_user', currentUser);
            localStorage.setItem('smart_student_user_role', 'teacher');
            
            // Simular estudiantes del curso
            const courseStudents = {
                'course_1': testStudents
            };
            localStorage.setItem('smart_student_course_students', JSON.stringify(courseStudents));
            
            log('‚úÖ Datos de prueba configurados correctamente', 'success');
            showCurrentNotifications();
        }
        
        function clearNotifications() {
            localStorage.removeItem('smart_student_notifications');
            submissions = [];
            log('üßπ Notificaciones limpiadas', 'info');
            updateNotificationsPanel();
        }
        
        function simulateStudentSubmission(studentUsername) {
            log(`üë§ Simulando entrega de ${studentUsername}...`, 'info');
            
            // Verificar si el estudiante ya entreg√≥
            const alreadySubmitted = submissions.some(s => s.studentUsername === studentUsername);
            if (alreadySubmitted) {
                log(`‚ö†Ô∏è ${studentUsername} ya entreg√≥ esta tarea`, 'warning');
                return;
            }
            
            // Agregar entrega
            submissions.push({
                studentUsername,
                taskId: testTask.id,
                timestamp: new Date().toISOString()
            });
            
            // Crear notificaci√≥n de entrega
            TaskNotificationManager.createTaskSubmissionNotification(
                testTask.id,
                testTask.title,
                testTask.course,
                testTask.subject,
                studentUsername,
                testTask.assignedById,
                testTask.taskType
            );
            
            log(`‚úÖ ${studentUsername} entreg√≥ la tarea`, 'success');
            
            // Verificar si todos los estudiantes han entregado
            checkAllStudentsSubmitted();
        }
        
        function simulateAllStudentsSubmit() {
            log('üìö Simulando que todos los estudiantes entregan...', 'info');
            
            testStudents.forEach(student => {
                simulateStudentSubmission(student.username);
            });
        }
        
        function checkAllStudentsSubmitted() {
            const submittedCount = submissions.filter(s => s.taskId === testTask.id).length;
            const totalStudents = testStudents.length;
            
            log(`üìä Entregas: ${submittedCount}/${totalStudents} estudiantes han entregado`, 'info');
            
            if (submittedCount === totalStudents) {
                log('üéâ ¬°Todos los estudiantes han entregado!', 'success');
                
                // Crear notificaci√≥n de tarea completa
                TaskNotificationManager.createTaskCompletedNotification(
                    testTask.id,
                    testTask.title,
                    testTask.course,
                    testTask.subject,
                    testTask.assignedById,
                    testTask.taskType
                );
                
                log('‚úÖ Notificaci√≥n de tarea completa enviada al profesor', 'success');
            }
        }
        
        function showCurrentNotifications() {
            const notifications = TaskNotificationManager.getNotifications();
            log(`üìã Notificaciones actuales: ${notifications.length}`, 'info');
            
            notifications.forEach(notif => {
                log(`üìå ${notif.type}: ${notif.taskTitle} - ${notif.fromDisplayName} -> ${notif.targetUsernames.join(', ')}`, 'info');
            });
            
            updateNotificationsPanel();
        }
        
        function updateNotificationsPanel() {
            const notifications = TaskNotificationManager.getNotifications();
            const teacherNotifications = notifications.filter(n => 
                n.targetUserRole === 'teacher' && n.targetUsernames.includes(currentUser)
            );
            
            // Separar notificaciones por tipo
            const pendingNotifications = teacherNotifications.filter(n => n.type === 'task_submission');
            const completedNotifications = teacherNotifications.filter(n => n.type === 'task_completed');
            
            // Actualizar panel de tareas pendientes
            const pendingPanel = document.getElementById('tasksPending');
            pendingPanel.innerHTML = '<h3>üìã Tareas Pendientes de Revisi√≥n</h3>';
            
            if (pendingNotifications.length === 0) {
                pendingPanel.innerHTML += '<p>No hay tareas pendientes de revisi√≥n</p>';
            } else {
                pendingNotifications.forEach(notif => {
                    const notifDiv = document.createElement('div');
                    notifDiv.className = 'notification-item notification-pending';
                    notifDiv.innerHTML = `
                        <strong>${notif.fromDisplayName}</strong> entreg√≥: <em>${notif.taskTitle}</em><br>
                        <small>Curso: ${notif.course} ‚Ä¢ Materia: ${notif.subject}</small><br>
                        <small>Fecha: ${new Date(notif.timestamp).toLocaleString()}</small>
                    `;
                    pendingPanel.appendChild(notifDiv);
                });
            }
            
            // Actualizar panel de tareas completadas
            const completedPanel = document.getElementById('tasksCompleted');
            completedPanel.innerHTML = '<h3>‚úÖ Tareas Completadas</h3>';
            
            if (completedNotifications.length === 0) {
                completedPanel.innerHTML += '<p>No hay tareas completadas</p>';
            } else {
                completedNotifications.forEach(notif => {
                    const notifDiv = document.createElement('div');
                    notifDiv.className = 'notification-item notification-completed';
                    notifDiv.innerHTML = `
                        <strong>üìö Tarea Completa:</strong> <em>${notif.taskTitle}</em><br>
                        <small>Todos los estudiantes han entregado</small><br>
                        <small>Curso: ${notif.course} ‚Ä¢ Materia: ${notif.subject}</small><br>
                        <small>Fecha: ${new Date(notif.timestamp).toLocaleString()}</small>
                    `;
                    completedPanel.appendChild(notifDiv);
                });
            }
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Sistema de notificaciones inicializado', 'success');
            updateNotificationsPanel();
        });
    </script>
</body>
</html>
